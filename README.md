# Audio Recorder Whereby Assistant

A Whereby Assistant implementation to generate audio-only recordings from room sessions.

## Installation

```
yarn install
```


## Running

Copy `.env.example` to `.env` and then add a `WHEREBY_ASSISTANT_KEY` value. This value can be obtained from the Whereby Embedded Admin Dashboard.

Then start the assistant with:

```
yarn start
```

To start assistant running on local-stack use:

```
yarn start:local
```

## Build and Deploy to AWS ECS Fargate

### Prerequisites

Requires AWS SAM to be installed ([guide](https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/install-sam-cli.html)).

### Define your infrastructure

To begin, you will want to provision your base infrastructure. This will stand up your Amazon Elastic Container Registry (ECR) so you can build and push your container image.

```sh
yarn aws:sam:init
```

Next, you will want to build and push your container image. Be sure to build this in x86_64 architecture.

```sh
yarn aws:sam:build
```

You can also find instructions to build and push this container image in the AWS Console for Elastic Container Registry. Once your repository has been created, you can drill down into that repo i.e. whereby-assistant-audio-recorder-ecrrepo-xxxxxx and then locate the "View Push Commands" button on the top right hand side. The `aws:sam:build` script fully above automates this flow.

Once you have your image built locally and pushed to your new registry, you are ready to deploy the rest of your infrastructure.

```sh
yarn aws:sam:deploy
```

### Test it out

Once the deployment completes, you should have the application running in your Amazon ECS cluster. You can run the following command to get the URL of your application.

```sh
yarn aws:sam:geturl
```

Once you have the URL of your application you should be able to load it in a web browser. If that works then you should now copy/paste the URL as the "Endpoint URL" in your Whereby Dashboard for a new or existing Whereby Assistant.

### Delete service from AWS

To remove all AWS configuration you can delete the CloudFormation stack generated by this repository.

```sh
yarn aws:sam:deploy:delete

# To also remove the Elastic Container Registry:
# yarn aws:sam:init:delete
```
