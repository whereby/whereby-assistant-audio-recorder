# Audio Recorder Whereby Assistant

A [Whereby Assistant](https://docs.whereby.com/meeting-content-and-quality/assistants) implementation to generate audio-only recordings from room sessions.

## Installation

```
yarn install
```

## Running

Copy `.env.example` to `.env` and then add a `WHEREBY_ASSISTANT_KEY` value. This value can be obtained from the Whereby Embedded Admin Dashboard. Optionally, you should also configure the `AWS_S3_*` values to upload audio recordings to an S3 bucket on exit.

Then start the assistant on your local machine with:

```
yarn start
```

To start assistant running on local-stack (Whereby internal tooling only) use:

```
yarn start:local
```

## Build and Deploy to AWS

This Whereby Assistant Audio Recorder can be easily deployed to an AWS environment using the Infrastructure-as-Code provided in this repository.

The tooling provided will create a deployment that includes an AWS Load Balancer running the Whereby Assistant in two separate AWS availability zones. This stack created will also auto-scale itself based on the CPU utilization of individual workers.

### Prerequisites

* A Whereby Embedded Account and a Whereby Assistant Key value ([setup guide](https://docs.whereby.com/meeting-content-and-quality/assistants))
* An AWS Account and AWS admin credentials for deploying the service
* AWS S3 bucket and credentials for writing audio recording files to S3 ([setup guide](https://whereby.com/blog/how-to-set-up-cloud-recording/))
* Node 20+
* [Docker](https://docs.docker.com/desktop/)
* [AWS CLI](https://docs.aws.amazon.com/cli/latest/userguide/getting-started-install.html)
* [AWS Serverless Application Model CLI (AWS SAM CLI)](https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/install-sam-cli.html)).


#### Create service secrets

For our application to successfully connect to Whereby rooms and upload to S3 we need to configure some parameters for our deployment. For this purpose we will create these parameters in the [AWS Secrets Manager](https://aws.amazon.com/secrets-manager/).

You will need to add a secret for every parameter included in the `.env.example` file.

You can choose to either create these secrets yourself ([guide](https://docs.aws.amazon.com/secretsmanager/latest/userguide/create_secret.html)) or we can simply run the following to set up these parameters on the command line, replacing each `value` with its secret string:

```sh
./scripts/create-aws-secret.sh WHEREBY_ASSISTANT_KEY value
./scripts/create-aws-secret.sh AWS_S3_ACCESS_KEY_ID value
./scripts/create-aws-secret.sh AWS_S3_SECRET_ACCESS_KEY value
./scripts/create-aws-secret.sh AWS_S3_REGION value
./scripts/create-aws-secret.sh AWS_S3_BUCKET_NAME value
```

### Define your infrastructure

Once our initial application secrets have been created in the previous section, you will want to provision your base infrastructure. This will stand up your Amazon Elastic Container Registry (ECR) so you can build and push your container images.

```sh
yarn aws:sam:init
```

Next, you will want to build and push your container docker image.

```sh
yarn aws:sam:build
```

Finally, once you have your docker image built locally and pushed to your new registry, you are ready to deploy the rest of your infrastructure.

```sh
yarn aws:sam:deploy
```

### Test it out

Once the deployment completes, you should have the application running in your Amazon ECS cluster. You can run the following command to get the URL of your application.

```sh
yarn aws:sam:meta:endpointurl
```

Once you have the URL of your application you should be able to load it in a web browser. If that works then you should now copy/paste the URL as the "Endpoint URL" in your Whereby Dashboard for a new or existing Whereby Assistant.

To see the live logs from the deployed service you can run the following command

```sh
yarn aws:sam:meta:logs:tail
```

### Redeploying the service

After making any changes to the source code, you can rebuild the container docker image, push a new image to the AWS ECR repository and re-deploy the service.

```sh
yarn aws:sam:build && yarn aws:sam:deploy
```

> NOTE: When re-deploying the service, all old instances in the ECR cluster will be immediately deregistered with the load balancer to stop handling new incoming requests and new instances will start and become registered with the load balancer. At this time, old instances will stay alive for a further 1 hour before being terminated so they can continue to handling in-progress sessions and connections.
>
> If you want to reduce the time that old instances stay alive after being deregistered from the load balancer you can adjust the `deregistriation_delay` setting in the AWS SAM config.

### Deleting the service from AWS

Terminating and permanently deleting the full CloudFormation stack generated by this repository is also possible.

```sh
yarn aws:sam:deploy:delete

# To also remove the Elastic Container Registry:
# yarn aws:sam:init:delete
```
